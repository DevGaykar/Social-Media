{% comment %} {%extends 'layouts/e.html'%} {% load static %} {% block content %} {% endcomment %}
{% load static %} 
<!DOCTYPE html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Inbox</title>
    <link rel="stylesheet" href="{% static 'inbox/inbox.css' %}" />
    <link rel="stylesheet" href="{% static '/style.css' %}" />
</head>

<script>
    document.getElementById('message-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const form = e.target;
        const formData = new FormData(form);
        
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Add the new message to the message list
                const messageList = document.querySelector('.message-list');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message sent';
                messageDiv.textContent = data.message.body;
                messageList.appendChild(messageDiv);
                
                // Clear the input
                form.reset();
                
                // Scroll to bottom
                messageList.scrollTop = messageList.scrollHeight;
            }
        })
        .catch(error => console.error('Error:', error));
    });
    </script>

<navbar>
    {%include "snippets/header.html"%}
</navbar>

<body>
{% comment %} <div class="middle"> {% endcomment %}
    <div class="container" >
        <aside class="conversation-list">
        {% if my_conversations %}
            {% for convo in my_conversations %}
                {% for participant in convo.participants.all %}
                    {% if participant != request.user %}
                    <div class="conversation-item {% if forloop.first %} active {%endif%}">
                        {% comment %} <a href="{% url 'inbox:inbox' convo.id %}">
                            <div class="profile-photo">
                                <img src={{ participant.profile.avatar}}>
                            </div>
                            <h3><img src={{ participant.profile.avatar}}>}</h3>
                        </a> {% endcomment %}
                        <a href="{% url 'inbox:inbox' convo.id %}">
                            <div class="profile-photo">
                                <img src={{ participant.profile.avatar}}>
                            </div>
                            <div class="handle">
                                <h4>{{ participant.profile.name }}</h4>
                                <p class="text-muted">
                                    @{{participant.username }}
                                </p>
                            </div>
                        </a>
                        {% comment %} <p>Hey, how are you?</p> {% endcomment %}
                    </div>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        {% else %}
            <p>No conversations found.</p>
        {% endif %}
        </aside>
 
        <main class="conversation-view">
            {% if conversation %}
             <header class="conversation-header">
                {% for participant in conversation.participants.all %}
                    {% if participant != request.user %}
                    <a href="{% url 'userprofile' participant.profile.user %}">
                        <div class="profile-photo">
                            <img src={{ participant.profile.avatar}}>
                        </div>
                        <div class="handle">
                            <h4>{{participant.profile.name}} </h4>
                            <p class="text-muted">
                                @{{participant.username }}
                            </p>
                        </div>
                    </a>
                    {% endif %}
                {% endfor %}
            </header> 
            <section class="message-list">
            {%for message in conversation.messages.all reversed%}
                <div class="message {% if message.sender == request.user %}sent{% else %}received{% endif %}">
                    {{message.body}}
                </div>
                {%endfor%}
            </section>
            <footer class="message-input">
                <form method="POST" action="{% url 'inbox:send_message' conversation.id %}" id="message-form">
                    {% csrf_token %}
                    <input type="text" name="body" placeholder="Type a message..." required>
                    <button type="submit">Send</button>
                </form>
            </footer>
            {% else %}
                <div class="no-conversation-selected">
                    <p>Select a conversation to start messaging</p>
                </div>
            {% endif %}
        </main>
    </div>
{% comment %} </div> {% endcomment %}
<body>
{% comment %} {%endblock%} {% endcomment %}